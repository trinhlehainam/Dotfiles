name: Claude PR Review

# =============================================================================
# Uses z.ai GLM-4.7 instead of Claude Code subscription ($3/mo vs $20/mo)
#
# Setup:
# 1. Get API key: https://z.ai/manage-apikey/apikey-list
# 2. Add GitHub secret: ZAI_API_KEY
# 3. No Claude Code subscription needed
#
# Docs:
# - https://docs.z.ai/devpack/tool/claude
# - https://github.com/anthropics/claude-code-action
# =============================================================================
on:
  pull_request:
    types: [opened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: PR Review with Progress Tracking
        uses: anthropics/claude-code-action@v1
        with:
          # Use z.ai API key instead of Claude Code OAuth token
          anthropic_api_key: ${{ secrets.ZAI_API_KEY }}
          prompt: "/review-pr REPO: ${{ github.repository }} PR_NUMBER: ${{ github.event.pull_request.number }}"
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment"
        env:
          # Point to z.ai's Anthropic-compatible endpoint
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          # Map Claude's Sonnet â†’ GLM-4.7 (z.ai's best coding model)
          ANTHROPIC_DEFAULT_SONNET_MODEL: glm-4.7
